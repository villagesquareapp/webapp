name: CI/CD

on:
  push:
    branches:
      - dev
      - main
  pull_request:
    branches: [dev, main]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set environment config
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "ENV_DIR=kubernetes/production" >> $GITHUB_ENV
            echo "ECR_REPO=prod-webapps" >> $GITHUB_ENV
            echo "API_URL=https://production-api.villagesquare.io/v2" >> $GITHUB_ENV
            echo "AUTH_URL=https://villagesquare.io" >> $GITHUB_ENV
          else
            echo "ENV_DIR=kubernetes/staging" >> $GITHUB_ENV
            echo "ECR_REPO=dev-webapps" >> $GITHUB_ENV
            echo "API_URL=https://staging-api.villagesquare.io/v2" >> $GITHUB_ENV
            echo "AUTH_URL=https://webdev.villagesquare.io" >> $GITHUB_ENV
          fi

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::606802968668:role/GitHubOIDCRole
          role-session-name: github-actions
          aws-region: af-south-1
          audience: sts.amazonaws.com

      - name: Configure kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region af-south-1 \
            --name kitops-eks \
            --role-arn arn:aws:iam::606802968668:role/GitHubOIDCRole

      - name: Log in to Amazon ECR
        run: |
          aws ecr get-login-password --region af-south-1 \
            | docker login --username AWS --password-stdin 606802968668.dkr.ecr.af-south-1.amazonaws.com

      - name: Generate Image Tag
        run: |
          IMAGE_TAG=$(date +%Y%m%d%H%M%S)
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Build Docker Image
        run: |
          docker build --no-cache \
            --build-arg NEXT_PUBLIC_API_URL=${{ env.API_URL }} \
            --build-arg NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }} \
            --build-arg NEXTAUTH_URL=${{ env.AUTH_URL }} \
            -t webapps:${{ env.IMAGE_TAG }} .

      - name: Tag Docker Image
        run: |
          docker tag webapps:${{ env.IMAGE_TAG }} \
            606802968668.dkr.ecr.af-south-1.amazonaws.com/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}

      - name: Push Docker Image to ECR
        run: |
          docker push 606802968668.dkr.ecr.af-south-1.amazonaws.com/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}

      - name: Output Image URI
        run: |
          echo "Image pushed to: 606802968668.dkr.ecr.af-south-1.amazonaws.com/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}"

      - name: Update deployment manifest with new image tag
        run: |
          sed -i "s|\(606802968668.dkr.ecr.af-south-1.amazonaws.com/${{ env.ECR_REPO }}\):[a-zA-Z0-9._-]*|\1:${{ env.IMAGE_TAG }}|" ${{ env.ENV_DIR }}/deployment.yml
          echo "=== Deployment after update ==="
          cat ${{ env.ENV_DIR }}/deployment.yml

      - name: Commit and Push Changes
        if: github.event_name == 'push'
        run: |
          git config --global user.name "villagesquareltd"
          git config --global user.email "villagesquare130@gmail.com"
          git add ${{ env.ENV_DIR }}/deployment.yml
          git commit -m "Updated ${{ github.ref_name }} image tag to ${{ env.IMAGE_TAG }}" || echo "No changes to commit"
          git push origin ${{ github.ref_name }}

      - name: Apply Kubernetes deployment
        run: |
          aws eks update-kubeconfig --region af-south-1 --name kitops-eks
          kubectl apply -f ${{ env.ENV_DIR }}/ --validate=false
